const API_URL = "http://localhost:5000/api";


// Register
const registerForm = document.getElementById('registerForm');
if(registerForm){
    registerForm.addEventListener('submit', async e => {
        e.preventDefault();
        const res = await fetch(`${API_URL}/users/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value
            })
        });
        const data = await res.json();
        if(data.token){
            localStorage.setItem('token', data.token);
            localStorage.setItem('role', data.user.role);
            registerForm.reset();
	    window.location.href = data.user.role === 'user' ? 'dashboard.html' : data.user.role === 'service_provider' ? 'service-provider.html' : 'admin.html';
        } else alert(data.msg || 'Registration failed');
    });
}

// Login
const loginForm = document.getElementById('loginForm');
if(loginForm){
    loginForm.addEventListener('submit', async e => {
        e.preventDefault();
        const res = await fetch(`${API_URL}/users/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            })
        });
        const data = await res.json();
        if(data.token){
            localStorage.setItem('token', data.token);
            localStorage.setItem('role', data.user.role);
	     
	                 // reset form
            loginForm.reset();
            window.location.href = data.user.role === 'user' ? 'dashboard.html' : data.user.role === 'service_provider' ? 'service-provider.html' : 'admin.html';
        } else alert(data.msg || 'Login failed');
    });
}

// Logout
const logoutBtn = document.getElementById('logoutBtn');
if(logoutBtn){
    logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('role');
        window.location.href = 'login.html';
    });
}

// Fetch services for user dashboard

const servicesContainer = document.getElementById('servicesContainer');

if(servicesContainer){
    fetch(`${API_URL}/services`)
    .then(res => res.json())
    .then(services => {
        servicesContainer.innerHTML = services.map(s => `
            <div class="bg-white shadow-lg rounded-lg overflow-hidden hover:shadow-2xl transition-shadow duration-300">
                <img src="${s.image ? `${API_URL.replace('/api','')}/uploads/${s.image}` : 'placeholder.png'}" class="w-full h-48 object-cover">
                <div class="p-4">
                    <h3 class="text-xl font-bold mb-2">${s.name}</h3>
                    <p class="text-gray-700 text-sm mb-4">${s.description || ''}</p>
                    <p class="text-lg font-bold mb-2">€${s.price}</p>
                    <button onclick="placeOrder('${s._id}')" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded">Order Now</button>
                </div>
            </div>
        `).join('');
    });
}


// Place order
async function placeOrder(serviceId){
    const token = localStorage.getItem('token');
    const res = await fetch(`${API_URL}/orders`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ serviceId })
    });
    const data = await res.json();
    alert(data.msg || 'Order placed successfully');
}

// Service Provider: Add new service

const serviceForm = document.getElementById('serviceForm');
if(serviceForm){
    serviceForm.addEventListener('submit', async e => {
        e.preventDefault();
        const token = localStorage.getItem('token');

        const formData = new FormData();
        formData.append('name', document.getElementById('serviceName').value);
        formData.append('description', document.getElementById('serviceDesc').value);
        formData.append('price', document.getElementById('servicePrice').value);
        const fileInput = document.getElementById('serviceImage');
        if(fileInput.files[0]) formData.append('image', fileInput.files[0]);

        const res = await fetch(`${API_URL}/services`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });

        const data = await res.json();
        if(data._id){
            alert('Service added successfully!');
            window.location.reload();
        } else {
            alert('Failed to add service');
        }
    });
}


/*

// Fetch Service Provider's services

const myServices = document.getElementById('myServices');
if(myServices){
    const token = localStorage.getItem('token');
    fetch(`${API_URL}/services`, { headers: { 'Authorization': `Bearer ${token}` } })
    .then(res => res.json())
    .then(services => {
        const providerId = JSON.parse(atob(token.split('.')[1])).id;
        const myServicesList = services.filter(s => s.provider._id === providerId);
        myServices.innerHTML = myServicesList.map(s => `
            <div class="bg-white p-4 rounded shadow">
                <h3 class="font-bold">${s.name}</h3>
                <img src="${s.image ? `${API_URL.replace('/api','')}/uploads/${s.image}` : 'placeholder.png'}" class="w-full h-40 object-cover rounded mt-2 mb-2">
                <p>${s.description || ''}</p>
                <p class="font-bold">€${s.price}</p>
            </div>
        `).join('');
    });
}
*/



// Fetch & Filter Service Provider's services

const myServices = document.getElementById('myServices');
if (myServices) {
    const token = localStorage.getItem('token');
    
    fetch(`${API_URL}/services`, { 
        headers: { 'Authorization': `Bearer ${token}` } 
    })
    .then(res => res.json())
    .then(services => {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const tokenPayload = JSON.parse(window.atob(base64));
        const loggedInId = String(tokenPayload.id || tokenPayload._id);

        const myServicesList = services.filter(s => {
            if (!s.provider) return false;
            const sProvId = (typeof s.provider === 'object') ? s.provider._id : s.provider;
            return String(sProvId) === loggedInId;
        });

        if (myServicesList.length === 0) {
            myServices.innerHTML = `<p class="col-span-full text-center py-10">No services found for your account.</p>`;
            return;
        }

        // Display cards with a forced Red Delete button
        myServices.innerHTML = myServicesList.map(s => `
            <div style="background: white; border: 1px solid #ddd; border-radius: 12px; padding: 15px; display: flex; flex-direction: column;">
                <img src="${s.image ? `${API_URL.replace('/api','')}/uploads/${s.image}` : 'https://via.placeholder.com/400x200'}" 
                     style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">
                <h3 style="font-weight: bold; margin-bottom: 5px;">${s.name}</h3>
                <p style="color: #666; font-size: 12px; flex-grow: 1;">${s.description || ''}</p>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; border-top: 1px solid #eee; pt: 10px;">
                    <span style="font-weight: bold; color: #00b894; font-size: 18px;">€${s.price}</span>
                    
                    <button onclick="window.deleteService('${s._id}')" 
                            style="background-color: #ff4757; color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer;">
                        DELETE
                    </button>
                </div>
            </div>
        `).join('');
    });
}

// Ye function file mein sabse niche hona chahiye
window.deleteService = async function(id) {
    if (!confirm("Are you sure you want to delete this service?")) return;

    const token = localStorage.getItem('token');
    
    // Debugging ke liye: console mein ID check karein
    console.log("Attempting to delete service with ID:", id);

    try {
        const res = await fetch(`${API_URL}/services/${id}`, {
            method: 'DELETE',
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (res.ok) {
            alert("Service deleted successfully!");
            window.location.reload(); 
        } else {
            // Agar error aaye toh console mein wajah dekhein
            const errorData = await res.json().catch(() => ({}));
            console.error("Delete failed on server:", errorData);
            alert("Delete failed: " + (errorData.message || "Server Error"));
        }
    } catch (err) {
        console.error("Network or Syntax Error:", err);
        alert("Check your connection or API URL.");
    }
}

/*
// Admin: Fetcl users
const usersContainer = document.getElementById('usersContainer');
if(usersContainer){
    const token = localStorage.getItem('token');
    fetch(`${API_URL}/users`, {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(res => res.json())
    .then(users => {
        usersContainer.innerHTML = users.map(u => `
            <div class="bg-white p-2 rounded shadow flex justify-between items-center">
                <span>${u.name} (${u.email}) - ${u.role}</span>
            </div>
        `).join('');
    })
    .catch(err => console.log(err));
}
*/



// Admin: Fetch users with Action Buttons


// Admin: Fetch users with Green UI Style
const usersContainer = document.getElementById('usersContainer');
if(usersContainer){
    const token = localStorage.getItem('token');
    fetch(`${API_URL}/users`, {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(res => res.json())
    .then(users => {
        usersContainer.innerHTML = users.map(u => `
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center w-full max-w-md hover:shadow-md transition">
                <div class="flex flex-col">
                    <span class="font-bold text-gray-800 text-sm">${u.name}</span>
                    <span class="text-[11px] text-gray-500 mb-1">${u.email}</span>
                    <span class="w-fit px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-tighter ${u.role === 'admin' ? 'bg-red-50 text-red-600' : 'bg-laundry-green/10 text-laundry-green'}">
                        ${u.role}
                    </span>
                </div>
                <div class="flex gap-2">
                    <button onclick="editUserRole('${u._id}', '${u.role}')" class="p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-600 hover:text-white transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                    </button>
                    <button onclick="deleteUser('${u._id}')" class="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-600 hover:text-white transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </div>
            </div>
        `).join('');
    });
}






/*
// Admin: Fetch all services
const allServices = document.getElementById('allServices');
if(allServices){
    const token = localStorage.getItem('token');
    fetch(`${API_URL}/services`, {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(res => res.json())
    .then(services => {
        allServices.innerHTML = services.map(s => `
            <div class="bg-white p-4 rounded shadow">
                <h3 class="font-bold">${s.name}</h3>
                <p>${s.description || ''}</p>
                <p class="font-bold">€${s.price}</p>
                <p>Provider: ${s.provider.name} (${s.provider.email})</p>
            </div>
        `).join('');
    });
}

*/



// Admin: Fetch All Services with Manage Options
const allServicesContainer = document.getElementById('allServices');
if(allServicesContainer){
    fetch(`${API_URL}/services`)
    .then(res => res.json())
    .then(services => {
        if(services.length === 0) {
            allServicesContainer.innerHTML = "<p class='text-gray-500'>No services available.</p>";
            return;
        }
        allServicesContainer.innerHTML = services.map(s => `
            <div class="bg-white p-4 rounded shadow border-l-4 border-blue-500 flex flex-col justify-between h-full">
                <div>
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-gray-800">${s.name}</h4>
                        <span class="text-emerald-600 font-bold text-lg">€${s.price}</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 italic">By: ${s.provider?.name || 'Unknown Provider'}</p>
                    <p class="text-sm text-gray-600 mt-2 line-clamp-2">${s.description || ''}</p>
                </div>
                
                <div class="mt-4 pt-3 border-t flex gap-2">
                    <button onclick="adminDeleteService('${s._id}')" 
                            class="bg-red-500 text-white flex-1 py-1.5 rounded text-xs font-bold hover:bg-red-700 transition">
                        REMOVE SERVICE
                    </button>
                </div>
            </div>
        `).join('');
    });
}

// Global Admin Delete Function for Services
window.adminDeleteService = async function(id) {
    if(!confirm("Admin Action: Delete this service from the platform?")) return;
    
    const token = localStorage.getItem('token');
    try {
        const res = await fetch(`${API_URL}/services/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if(res.ok) {
            alert("Service removed by Admin!");
            location.reload();
        } else {
            alert("Error: Admin authorization failed.");
        }
    } catch (err) {
        console.error(err);
    }
};


/*
// Admin: Fetch all orders
const allOrders = document.getElementById('allOrders');
if(allOrders){
    const token = localStorage.getItem('token');
    fetch(`${API_URL}/orders`, {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(res => res.json())
    .then(orders => {
        allOrders.innerHTML = orders.map(o => `
            <div class="bg-white p-4 rounded shadow flex justify-between items-center">
                <div>
                    <p>User: ${o.user.name} (${o.user.email})</p>
                    <p>Service: ${o.service.name}</p>
                    <p>Status: <span id="status-${o._id}" class="font-bold">${o.status}</span></p>
                </div>
                <div class="flex flex-col gap-2">
                    <button onclick="updateOrderStatus('${o._id}','pending')" class="bg-yellow-500 p-1 rounded text-white">Pending</button>
                    <button onclick="updateOrderStatus('${o._id}','completed')" class="bg-green-500 p-1 rounded text-white">Completed</button>
                </div>
            </div>
        `).join('');
    });
}



// Admin: Update order status
async function updateOrderStatus(orderId, status){
    const token = localStorage.getItem('token');
    const res = await fetch(`${API_URL}/orders/${orderId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ status })
    });
    const data = await res.json();
    if(data._id){
        document.getElementById(`status-${orderId}`).innerText = data.status;
        alert('Order status updated');
    } else {
        alert('Failed to update order');
    }
}
*/

// Admin: Fetch All Orders with Actions
const allOrdersContainer = document.getElementById('allOrders');
if(allOrdersContainer){
    const token = localStorage.getItem('token');
    fetch(`${API_URL}/orders/all`, {
        headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(res => res.json())
    .then(orders => {
        allOrdersContainer.innerHTML = orders.map(o => `
            <div class="bg-white p-4 rounded shadow border-l-4 border-yellow-500 mb-3">
                <div class="flex justify-between items-center">
                    <div>
                        <span class="text-xs font-bold text-gray-400">#${o._id.slice(-6)}</span>
                        <h4 class="font-bold text-gray-800">${o.service?.name || 'Service'}</h4>
                        <p class="text-xs text-gray-500 italic">User: ${o.user?.name || 'Guest'}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg text-emerald-600">€${o.totalAmount || 0}</p>
                        <span class="text-[10px] font-bold uppercase px-2 py-0.5 rounded ${o.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                            ${o.status}
                        </span>
                    </div>
                </div>
                
                <div class="mt-4 pt-3 border-t flex gap-2">
                    <button onclick="updateOrderStatus('${o._id}', '${o.status}')" class="bg-blue-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-600 transition">
                        Change Status
                    </button>
                    <button onclick="deleteOrder('${o._id}')" class="bg-red-500 text-white px-3 py-1 rounded text-xs font-bold hover:bg-red-600 transition">
                        Delete
                    </button>
                </div>
            </div>
        `).join('');
    });
}

// Global Function: Update Order Status
window.updateOrderStatus = async function(id, currentStatus) {
    const newStatus = currentStatus === 'pending' ? 'completed' : 'pending';
    if(!confirm(`Change status to ${newStatus}?`)) return;

    const token = localStorage.getItem('token');
    const res = await fetch(`${API_URL}/orders/${id}/status`, {
        method: 'PUT',
        headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json' 
        },
        body: JSON.stringify({ status: newStatus })
    });
    if(res.ok) {
        alert("Status Updated!");
        location.reload();
    }
};

// Global Function: Delete Order
window.deleteOrder = async function(id) {
    if(!confirm("Delete this order record permanently?")) return;
    const token = localStorage.getItem('token');
    const res = await fetch(`${API_URL}/orders/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
    });
    if(res.ok) {
        alert("Order Deleted!");
        location.reload();
    }
};
